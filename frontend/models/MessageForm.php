<?php/** * Created by PhpStorm. * User: wayne * Date: 2016/12/31 * Time: 5:29 */namespace frontend\models;use common\models\Message;use common\models\User;use yii\base\Model;use Yii;class MessageForm extends Model {    //添加【消息】    public function addMessage($fromUser, $toUser, $postId, $postTitle){        $model = new Message();        $model->from_user = $fromUser;        $model->to_user = $toUser;        $model->content = '<a href="index.php?r=user/userpage&username='.$fromUser.'">'.$fromUser.'</a>&nbsp&nbsp回复了你的帖子: <a href="index.php?r=club/detail&id='. $postId .'">' . $postTitle . '</a>';        $model->create_time = time();        if ($model->save()){            $this->_updateMessageNum($toUser);        }    }    //获取【消息】    public function getMessage(){        $userName = Yii::$app->user->identity->username;        $messages = Message::find()->select(['content', 'create_time'])->where(['to_user' => $userName, 'static' => 1])->asArray()->all();        foreach ($messages as $k => $message){            $messages[$k]['time'] = date('m-d h:i', $message['create_time']);            unset($messages[$k]['create_time']);        }        Message::updateAll(['static' => 0], ['to_user' => $userName, 'static' => 1]);        User::updateAll(['message_num' => 0], ['username' => $userName]);        return $messages;    }    //添加【私信】    public function addLetter($post){        $letter = htmlspecialchars(strip_tags($post['letter']));        $toUser = htmlspecialchars(strip_tags($post['toUser']));        $fromUser = Yii::$app->user->identity->username;        $model = new Message();        $model->to_user = $toUser;        $model->content = '来自用户 <a href="index.php?r=user/userpage&username='.$fromUser.'">'.$fromUser.'</a> 的信息：'.$letter;        $model->create_time = time();        $model->from_user = $fromUser;        if (!$model->save()){            return false;        }        $this->_updateMessageNum($toUser);        return true;    }    //将user表中的message_num【消息数】的数值加一    public function _updateMessageNum($userName){        $userModel = User::find()->where(['username' => $userName])->one();        $userModel->updateCounters(['message_num' => 1]);    }}