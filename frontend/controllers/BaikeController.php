<?php/** * Created by PhpStorm. * User: wayne * Date: 2016/11/22 * Time: 18:12 */namespace frontend\controllers;use common\models\Baike;use common\models\Cats;use common\models\Provinces;use frontend\models\BaikeForm;use frontend\models\BookChapterForm;use frontend\models\RelationBaikeTagForm;use Yii;class BaikeController extends BaseController {    public function actions()    {        return [            'captcha' => [                'class' => 'yii\captcha\CaptchaAction',                'fixedVerifyCode' => YII_ENV_TEST ? 'testme' : null,            ],        ];    }    public function actionIndex(){        return $this->render('index');    }    public function actionHealth(){        $provinceData = Provinces::find()->asArray()->all();        return $this->render('health', ['provinces' => $provinceData]);    }    /*搜索百科(根据关键字)*/    public function actionSearch(){        $keyword = Yii::$app->request->get('keyword');        $searchData = BaikeForm::getSearch($keyword);        if (empty($searchData)){            return json_encode(['err' => 0]);  //没有相关数据        }        return json_encode($searchData);    }    /*通过标签获取百科数据*/    public function actionSearchByTag(){        $tagId = Yii::$app->request->get('tagId');        $searchData = RelationBaikeTagForm::getSearchByTag($tagId);        if (empty($searchData)){            return json_encode(['err' => 0]);  //没有相关数据        }        return json_encode($searchData);    }    //创建文章(使用百度编辑器，已废弃)    public function actionCreate(){        if (Yii::$app->user->isGuest){            Yii::$app->getSession()->setFlash('error', '请先登录！');            return $this->redirect(['site/login']);        }        $model = new BaikeForm();        $model->setScenario(BaikeForm::SCENARIO_CREATE); //设置场景        if ($model->load(\Yii::$app->request->post()) && $model->validate()){            if (!$model->create()){                Yii::$app->session->setFlash('warning', $model->_lastError);            }else{                return $this->redirect(['baike/view', 'id' => $model->id]);            }        }        //获取分类        $catsObj = new Cats();        $cats = $catsObj->getCats();        return $this->render('create', ['model' => $model, 'cats' => $cats]);    }    //编辑博文（替代上面的【创建文章】）    public function actionEdit(){        //$this->layout = 'simple_layout';        if (Yii::$app->user->isGuest){            Yii::$app->getSession()->setFlash('error', '请先登录！');            return $this->redirect(['site/login']);        }        $model = new BaikeForm();        $model->setScenario(BaikeForm::SCENARIO_CREATE); //设置场景        if ($model->load(\Yii::$app->request->post()) && $model->validate()){            if (!$model->create()){                \Yii::$app->session->setFlash('warning', $model->_lastError);            }else{                return $this->redirect(['baike/view', 'id' => $model->id]);            }        }        return $this->render('edit', ['model' => $model]);    }    //浏览单条百科文章（根据id）    public function actionView(){        $baikeId = (int)Yii::$app->request->get('id');        if ($chapterId = (int)Yii::$app->request->get('book_chapter')){            $baikeData = (new BookChapterForm())->getChapter($chapterId);        }else{            $baikeData = BaikeForm::getBaikeDataById($baikeId);//获取指定文章id的数据        }        //浏览次数自增1        $baikeObj = Baike::findOne($baikeId);        $baikeObj->updateCounters(['browser' => 1]);        return $this->render('view', ['baike' => $baikeData]);    }}